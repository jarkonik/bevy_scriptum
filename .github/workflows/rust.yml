name: Rust

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: -D warnings
    steps:
      - uses: actions/checkout@v3
      - name: Install Ruby
        env:
          CC: clang
        run: |
          url="https://cache.ruby-lang.org/pub/ruby/3.4/ruby-3.4.4.tar.gz"
          mkdir ruby_src
          curl -sSL $url | tar -xz --directory=./ruby_src
          cd ruby_src
          mkdir build && cd build
          mkdir rubies
          ../configure --without-shared --prefix="${pwd}/rubies/ruby-3.4"
          make install
          echo `pwd`/rubies/ruby-3.4/ruby/bin >> $GITHUB_PATH
      - name: Clippy
        run: cargo clippy --all-features --verbose -- -D warnings
      - name: Build
        run: cargo build --all-features --verbose
      - name: Run tests
        run: cargo test --all-features --verbose
